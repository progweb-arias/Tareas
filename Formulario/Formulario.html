<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
        <link href="Estilos.css" rel="stylesheet" type="text/css">
        <Title>Datos</Title>
    </head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js" type="text/javascript">
    </script>
    <body>
        <!-- <form method="POST"> -->
        <div class="container">
            <div class="form-group">
                <label for="exampleInputNombre1">Nombre:</label>
                <input type="text" class="form-control" id="texto" name="texto" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="exampleInputEdad1">Edad:</label>
                <input type="number" class="form-control" id="numero" name="numero" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="exampleInputFecha1">Fecha de nacimiento:</label>
                <input type="date" class="form-control" id="fecha" name="fecha" autocomplete="off">
            </div>
            <div style="margin-top: 5px;">
                <button id="validate" class="btn btn-primary">Validar</button>
                <button id="saving" class="btn btn-primary">Guardar</button>
                <button id="delete" class="btn btn-primary"> Borrar</button>
            </div>
            <div id="result" style= "display: none"></div>
        </div>
        <!-- </form> -->
    </body>
    <script>
        // Funcion para guardar datos en ella.
        function getData(){
            const nombre= $('#texto').val();
            const edad= $('#numero').val();
            const fecha_nacimiento= $('#fecha').val();
            return{
                texto: nombre,
                numero: edad.toString(),
                fecha: fecha_nacimiento,
            }
        }
        function showErrors(data){
                data.forEach(function(error){
                    $('#result').hide().removeClass("alert-danger").removeClass("alert-success").addClass("alert");
                    $('#'+error).addClass("alert alert-danger");
                    // Sale al padre y Si no tiene small lo a√±ade por tener menos caracteres
                    if($('#'+error).parent().find('small').length <1){
                        $('#'+error).after("<small>No es valido</small>");
                    }
                })
        }
        function showCorrectos(data){
                data.forEach(function(correcto){
                    $('#result').hide().removeClass("alert-danger").removeClass("alert-success").addClass("alert");
                    $('#'+correcto).addClass("alert alert-success");
                    if($('#'+correcto).parent().find('small').length >0){
                        $('#'+correcto).parent().find('small').hide();
                        $('#'+correcto).removeClass("alert-danger").addClass("alert-success");
                    }
                })

        }
        function callapi(action){
            return $.ajax({
                method: "POST",
                url: "api.php?action="+action,
                data: getData(),
            });
        }
        function checkUrl(data){
            if(typeof (data) == 'string'){
                        $('#result').addClass('alert-danger');
                        $('#result').append('Fallo en el Action.');
                        return false;
                }
            return true;
        }
        // Cuando das click en boton validar
        $(document).on ('click','#validate',function(){
            // Entra en el ajax y introduce parametros en api.php
            let callApi = callapi('validate');
            // Una vez mandado los datos realiza los siguientes pasos
            callApi.done(function(data){
                // Traducir los datos que recibe del encode que hay en api.php con el JSON.parse
                resultados=JSON.parse(data);
                // Comprobacion del action 
                if(!checkUrl(resultados)){
                    return;
                };
                if(data.lenght<1){
                    return;
                }
                showCorrectos(resultados.correcto);
                showErrors(resultados.error);
            })
        })
        // Cuando das en click en boton guardar
        $(document).on('click','#saving',function(){
            // Entra en el ajax y introduce parametros en api.php
            let callApi=callapi('save_validate');
            // Una vez mandado los datos realiza los siguientes pasos
            callApi.done(function(data){
                // Traducir los datos que recibe del encode que hay en api.php con el JSON.parse
                resultados=JSON.parse(data);
                $('#result').show().removeClass("alert-danger").removeClass("alert-success").addClass("alert");
                $('#result').empty();
                // Comprobacion del action
                if(!checkUrl(resultados)){
                    return;
                };
                if(typeof resultados.error !='undefined'){
                    showErrors(resultados.error);
                    $('#result').hide();
                    return;
                }
                if(resultados){
                    $('.form-group input').addClass('alert-success');
                    $('#result').addClass('alert-success').append('Todo correcto');
                    $('.form-group input').removeClass('alert-danger').addClass('alert-success');
                    $('.form-group small').hide();
                }
                else{
                    $('#result').addClass("alert-danger");
                    $('.form-group small').show();    
                    $('.form-group input').removeClass('alert-success').addClass('alert-danger');
                    $('#result').append('Faltan Datos');
                }
            })
        })
        // Cuando das click en boton borrar
        $(document).on('click','#delete',function(){
            $confirmacion = confirm("Estas seguro?");
            if(!$confirmacion){
                return;
            }
            // Si no encuentra los datos introducidos saca mensaje error
            if($('#texto').val().trim().length<1){
                $('#texto').addClass("alert alert-danger");
                $('#result').empty();
                $('#result').show().addClass("alert alert-danger");
                $('#result').append("Error.Falta atributo nombre");
            }
            // Si encuentra entra en el ajax y introduce parametros en api.php
            else{
                let callApi=callapi('delete');
                // Una vez mandado los datos realiza los siguientes pasos
                callApi.done(function(data){
                    // Traducir los datos que recibe del encode que hay en api.php con el JSON.parse
                    resultados=JSON.parse(data);
                    $('#result').show().addClass("alert");
                    $('#result').empty();
                    // Comprobar el action
                    if(!checkUrl(resultados)){
                        return;
                    };
                    if(typeof resultados == 'boolean'){
                        if(resultados){
                            $('#result').append('Datos Borrados');
                            $('#result').removeClass('alert-danger').addClass('alert-success');
                        }
                        return;
                    }
                    $('.form-group input').removeClass('alert-danger').addClass('alert-success');
                    $('#result').addClass("alert-danger");
                    $('#result').append("No hay datos en la tabla");  
                })
            }
        })
    </script>
</html> 