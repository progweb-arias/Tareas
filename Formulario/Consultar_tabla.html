<html>

<head>
    <title>Mostrar tabla</title>
    <link href="Estilos.css" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
</head>

<body>
    <div class="container">
        <form class="form-inline" style="margin-top: 5px;" id="formulario">
            <legend id="titulo_formulario">Formulario/Tabla</legend>
            <div class="col-sm-3">
                <div class="form-group">
                    <label for="texto">Nombre</label>
                    <input name="texto" type="text" class="form-control" id="texto" autocomplete="off"
                        placeholder="Nombre">
                </div>
            </div>
            <div class="col-sm-3">
                <div class="form-group">
                    <label for="fecha_desde">Fecha_desde</label>
                    <input name="fecha_desde" type="date" class="form-control" id="fecha_desde" autocomplete="off"
                        placeholder="Fecha_desde" min="" max="">
                </div>
            </div>
            <div class="col-sm-3">
                <div class="form-group">
                    <label for="fecha_hasta">Fecha_hasta</label>
                    <input name="fecha_hasta" type="date" class="form-control" id="fecha_hasta" autocomplete="off">
                </div>
            </div>
            <div class="col-sm-2">
                <div class="form-group">
                    <label for="boton">Borrado?</label>
                    <input name="boton" type="checkbox" checked data-toggle="toggle" data-onstyle="primary" id="boton">
                </div>
            </div>
            <div class="col-sm-1">
                <button type="button" class="btn btn-primary" id="enviar" style="margin-top: 25px;">Enviar</button>
            </div>
        </form>
        <table class="table" id="tabla">
        </table>
    </div>
</body>
<script>
    function getData() {
        const nombre = $('#texto').val();
        const fecha1 = $('#fecha_desde').val();
        const fecha2 = $('#fecha_hasta').val();
        const borrado = $('#boton').is(':checked');
        return {
            texto: nombre,
            fecha_desde: fecha1,
            fecha_hasta: fecha2,
            boton: borrado,
        }
    }

    function showTable(data) {
        var tabla =
            '<tr><th style="text-align: center">Nombre</th><th style="text-align: center">Edad</th><th style="text-align: center">Fecha</th><th style="text-align: center">Fecha_creacion</th><th style="text-align: center">Fecha_modificacion</th><th style="text-align: center">deleted</th><th style="text-align: center">date_deleted</th><th style="text-align: center">Accion</th></tr>';
        var iconos =
            '<svg id="validate" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#00b341" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg><svg id="save_validate" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-file-upload" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#00abfb" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><line x1="12" y1="11" x2="12" y2="17" /><polyline points="9 14 12 11 15 14" /></svg><svg id="delete" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ff2825" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="7" x2="20" y2="7" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>'
        $.each((data), function (key, i) {
            // console.log(i);
            tabla += (
                '<tr style="text-align: center" class="validar"><td><input type="text"  class="nombre form-control" autocomplete="off" value="' +
                i.Nombre +
                '"></td><td><input type="number"  class="edad form-control" autocomplete="off" value="' +
                i.Edad +
                '"></td><td><input type="date" class="fecha form-control" autocomplete="off" value="' +
                i.Fecha +
                '"></td><td id="fecha_creacion_tabla"><input type="datetime" class="fecha_creacion form-control" value="' +
                i.Fecha_creacion +
                '" readonly></td><td id="fecha_modificacion_tabla"><input type="datetine" class="form-control" value="' +
                i.Fecha_Modificacion +
                '" readonly></td><td id="deleted_tabla"><input type="number" class="deleted form-control" value="' +
                i.deleted +
                '"readonly></td><td id="date_deleted_tabla"><input type="datetime" class="form-control" value="' +
                i
                .date_deleted + '" readonly></td><td>' + iconos +
                '</td></tr>');
            // console.log(tabla);
        });
        return $('#tabla').empty().append(tabla);
    }

    function callapi(action) {
        return $.ajax({
            method: "POST",
            url: "api.php?action=" + action,
            data: getData(),
        })
    }

    function callapi2(action) {
        return $.ajax({
            method: "POST",
            url: "api.php?action=" + action,
            data: dataTable.call(this),
            context: this,
        })
    }

    function dataTable() {
        const nombre_tabla = $(this).closest('tr').find('input[class="nombre form-control"]').val();
        const edad_tabla = $(this).closest('tr').find('input[class="edad form-control"]').val();
        const fecha_tabla = $(this).closest('tr').find('input[class="fecha form-control"]').val();
        const fecha_creacion_tabla = $(this).closest('tr').find('input[class="fecha_creacion form-control"]').val();
        // const deleted_tabla = $(this).closest('tr').find('input[class="deleted form-control"]').val();
        return {
            texto: nombre_tabla,
            numero: edad_tabla,
            fecha: fecha_tabla,
            fecha_desde: fecha_creacion_tabla,
        }
    }
    $('#fecha_desde').change(function () {
        $('#fecha_hasta').attr("min", $('#fecha_desde').val())
    })
    $('#fecha_hasta').change(function () {
        $('#fecha_desde').attr("max", $('#fecha_hasta').val())
    })
    $(document).on('click', '#enviar', function () {
        let callApi = callapi('search');
        callApi.done(function (data) {
            resultados = JSON.parse(data);
            showTable(resultados);
            console.log(boton);
            if ($('#boton').is(':checked')) {
                $('svg[class="icon icon-tabler icon-tabler-trash"]').hide();
            }
        })
    })
    $(document).on('click', '#validate', function () {
        let callApi2 = callapi2.call(this, 'validate');
        callApi2.done(function (data) {
            let a = $(this).closest('tr');
            resultados2 = JSON.parse(data);
            a.removeClass('bg-danger').removeClass('bg-success');
            a.find('#save_validate').show();
            resultados2.error.forEach(function (error) {
                a.addClass('bg-danger');
                a.find('#save_validate').hide();
            });
            resultados2.correcto.forEach(function (correcto) {
                a.addClass('bg-success');
            })
        })
    })
    $(document).on('click', '#save_validate', function () {
        let callApi3 = callapi2.call(this, 'update');
        callApi3.done(function (data) {
            let a = $(this).closest('tr');
            resultados3 = JSON.parse(data);
            console.log(resultados3);
            a.removeClass('bg-danger').removeClass('bg-success');
            if (resultados3 != true) {
                a.addClass('bg-danger');
            }
            a.addClass('bg-success');
            alert('Datos almacenados en la tabla');
        })
    })
    $(document).on('click', '#delete', function () {
        let callApi4 = callapi2.call(this, 'delete');
        callApi4.done(function (data) {
            let a = $(this).closest('tr');
            resultados4 = JSON.parse(data);
            a.removeClass('bg-danger');
            if (resultados4 != true) {
                a.addClass('bg-danger');
            }
            if (resultados4 == true) {
                a.hide();
                alert('Datos Borrados');
            }
            a.addClass('bg-danger');
        })
    })
</script>

</html>