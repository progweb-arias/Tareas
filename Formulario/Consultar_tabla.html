<html>

<head>
    <title>Mostrar tabla</title>
    <link href="Estilos.css" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
</head>

<body>
    <!-- TODO el label de los inputs tiene que estar encima del input, se hace por css -->
    <div class="container">
        <form class="form-inline" style="margin-top: 5px;" id="formulario">
            <legend id="titulo_formulario">Formulario/Tabla</legend>
            <div class="col-sm-2">
                <div class="flex-column form-group">
                    <label for="texto">Nombre: </label>
                    <input name="texto" type="text" class="form-control" id="texto" autocomplete="off"
                        placeholder="Nombre">
                </div>
            </div>
            <div class="col-sm-2">
                <div class="flex-column form-group">
                    <label for="fecha_desde">Fecha_desde: </label>
                    <input name="fecha_desde" type="date" class="form-control" id="fecha_desde" autocomplete="off"
                        placeholder="Fecha_desde" min="" max="">
                </div>
            </div>
            <div class="col-sm-2">
                <div class="flex-column form-group">
                    <label for="fecha_hasta">Fecha_hasta: </label>
                    <input name="fecha_hasta" type="date" class="form-control" id="fecha_hasta" autocomplete="off">
                </div>
            </div>
            <div class="col-sm-2">
                <div class="flex-column form-group">
                    <label for="fecha_hasta">Fecha a filtrar </label>
                    <select class="form-control" id="fecha_eleccion">
                        <option>Fecha</option>
                        <option>Fecha_creacion</option>
                        <option>Fecha_modificacion</option>
                    </select>
                </div>
            </div>
            <div class="col-sm-2">
                <div class="flex-column form-group">
                    <label for="boton">Borrado: </label>
                    <input name="boton" type="checkbox" data-toggle="toggle" data-onstyle="primary" id="boton">
                </div>
            </div>
            <div class="col-sm-1">
                <button type="button" class="btn btn-primary" id="enviar" style="margin-top: 25px;">Buscar</button>
            </div>
        </form>
        <table class="table" id="tabla">
        </table>
        <nav>
            <ul class="pagination" id="botones">

            </ul>
        </nav>
    </div>
    <div id="paginas">
    </div>
</body>
<script>
    function getData() {
        const nombre = $('#texto').val();
        const fecha1 = $('#fecha_desde').val();
        const fecha2 = $('#fecha_hasta').val();
        const borrado = $('#boton').is(':checked');
        const seleccion_fecha = $('#fecha_eleccion').val();
        const boton = $(this).attr('id');
        return {
            texto: nombre,
            fecha_desde: fecha1,
            fecha_hasta: fecha2,
            boton: borrado,
            fecha_eleccion: seleccion_fecha,
            boton1: boton,
        }
    }

    function showTable(data) {

        var tabla =
            '<thead><tr><th style="text-align: center">Nombre</th><th style="text-align: center">Edad</th><th style="text-align: center">Fecha</th><th style="text-align: center">Fecha_creacion</th><th style="text-align: center">Fecha_modificacion</th><th style="text-align: center">deleted</th><th style="text-align: center">date_deleted</th><th style="text-align: center">Accion</th></tr></thead><tbody id="body_table"';
        var iconos =
            '<svg id="validate" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#00b341" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg><svg id="update" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-file-upload" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#00abfb" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><line x1="12" y1="11" x2="12" y2="17" /><polyline points="9 14 12 11 15 14" /></svg><svg id="delete" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ff2825" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="7" x2="20" y2="7" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>'
        var fila =
            '<tr id="result"><td><input type="text" class="texto form-control" id="texto_añadir"></td><td><input type="number" class="numero form-control" id="numero_añadir"></td><td><input type="date" class="fecha form-control" id="fecha_añadir"></td><td></td><td></td><td></td><td></td><td><svg id="validate" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#00b341" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-circle-plus" id="save_validate" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ffec00" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9" /><line x1="9" y1="12" x2="15" y2="12" /><line x1="12" y1="9" x2="12" y2="15" /></svg></td></tr></tbody>';
        $.each((data), function (key, i) {
            tabla += getRow(i);
        });
        return $('#tabla').empty().append(tabla).append(fila);
    }

    function callapi(action) {
        return $.ajax({
            method: "POST",
            url: "api.php?action=" + action,
            data: getData.call(this),
            context: this,
        })
    }

    function callapi2(action) {
        return $.ajax({
            method: "POST",
            url: "api.php?action=" + action,
            data: dataTable.call(this),
            context: this,
        })
    }

    function dataTable() {
        const nombre_tabla = $(this).closest('tr').find('input[type="text"]').val();
        const edad_tabla = $(this).closest('tr').find('input[type="number"]').val();
        const fecha_tabla = $(this).closest('tr').find('input[type="date"]').val();
        const fecha_creacion_tabla = $(this).closest('tr').find('input[class="fecha_creacion form-control"]').val();
        return {
            texto: nombre_tabla,
            numero: edad_tabla,
            fecha: fecha_tabla,
            fecha_desde: fecha_creacion_tabla,
        }
    }

    function getRow(i) {
        var iconos =
            '<svg id="validate" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#00b341" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5l10 -10" /></svg><svg id="update" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-file-upload" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#00abfb" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><line x1="12" y1="11" x2="12" y2="17" /><polyline points="9 14 12 11 15 14" /></svg><svg id="delete" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#ff2825" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="7" x2="20" y2="7" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>'
        return '<tr style="text-align: center" class="validar"><td><input type="text"  class="texto form-control" autocomplete="off" value="' +
            i.Nombre +
            '"></td><td><input type="number"  class="numero form-control" autocomplete="off" value="' +
            i.Edad +
            '"></td><td><input type="date" class="fecha form-control" autocomplete="off" value="' +
            i.Fecha +
            '"></td><td id="fecha_creacion_tabla"><input type="datetime" class="fecha_creacion form-control" value="' +
            i.Fecha_creacion +
            '" readonly></td><td id="fecha_modificacion_tabla"><input type="datetine" class="form-control" value="' +
            i.Fecha_Modificacion +
            '" readonly></td><td id="deleted_tabla"><input type="number" class="deleted form-control" value="' +
            i.deleted +
            '"readonly></td><td id="date_deleted_tabla"><input type="datetime" class="form-control" value="' +
            i
            .date_deleted + '" readonly></td><td>' + iconos +
            '</td></tr>';
    }

    $('#fecha_desde').change(function () {
        $('#fecha_hasta').attr("min", $('#fecha_desde').val())
    })
    $('#fecha_hasta').change(function () {
        $('#fecha_desde').attr("max", $('#fecha_hasta').val())
    })
    $(document).on('click', '#enviar', function () {
        let callApi = callapi('search');
        callApi.done(function (data) {
            resultados = JSON.parse(data);
            // console.log($('#fecha_eleccion').val());
            let paginas = Math.ceil(resultados.contador / 5);
            let botones = " ";
            for (i = 0; i < paginas; i++) {
                botones +=
                    '<li class="page-item"><input type="button" class="page-link" id=' + i +
                    ' value=' + (parseInt(i) + parseInt(1)) + '></li>'
            }
            $('#botones').empty().append(botones);
            showTable(resultados.datos);
            let valor = $('#tabla').find('tr').length;
            if ($('#boton').is(':checked')) {
                $('svg[class="icon icon-tabler icon-tabler-trash"]').hide();
            }
        })
    })
    $(document).on('click', '#validate', function () {
        let callApi2 = callapi2.call(this, 'validate');
        callApi2.done(function (data) {
            let a = $(this).closest('tr');
            resultados2 = JSON.parse(data);
            $('tr').removeClass('alert alert-danger').removeClass('alert alert-success');
            a.removeClass('alert alert-danger').removeClass('alert alert-success');
            $('input').removeClass('alert alert-danger').removeClass('alert alert-success');
            a.find('#save_validate').show();
            resultados2.error.forEach(function (error) {
                a.addClass('alert alert-danger');
                a.find('input[class="' + error + ' form-control"]').addClass(
                    'alert alert-danger');
                a.find('#save_validate').hide();
            });
            resultados2.correcto.forEach(function (correcto) {
                a.addClass('alert alert-success');
                a.find('input[class="' + correcto + ' form-control"]').addClass(
                    'alert alert-success');
            })
        })
    })
    $(document).on('click', '#update', function () {
        let callApi3 = callapi2.call(this, 'update');
        callApi3.done(function (data) {
            let a = $(this).closest('tr');
            resultados3 = JSON.parse(data);
            a.removeClass('alert alert-danger').removeClass('alert alert-success');
            if (resultados3 != true) {
                a.addClass('alert alert-danger');
            }
            a.addClass('alert alert-success');

        })
    })
    $(document).on('click', '#delete', function () {
        let pregunta = confirm("Estas seguro?");
        if (!pregunta) {
            return;
        }
        let callApi4 = callapi2.call(this, 'delete');
        callApi4.done(function (data) {
            let a = $(this).closest('tr');
            resultados4 = JSON.parse(data);
            // console.log(resultados4);
            a.removeClass('alert alert-danger');
            if (resultados4 != true) {
                a.addClass('alert alert-danger');
            }
            if (resultados4 == true) {
                a.hide();
            }
            a.addClass('alert alert-danger');
            let callApi8 = callapi.call(this, 'search');
            callApi8.done(function (data) {
                resultados8 = JSON.parse(data);
                // console.log(resultados8);
                let paginas = Math.ceil(resultados8.contador / 5);
                let botones = " ";
                for (i = 0; i < paginas; i++) {
                    botones +=
                        '<li class="page-item"><input type="button" class="page-link" id=' +
                        i +
                        ' value=' + (parseInt(i) + parseInt(1)) + '></li>'
                }
                let fin = parseInt(i) - parseInt(1);
                // console.log(fin);
                $('#botones').empty().append(botones);
                if (((resultados8.contador) % 5) == 0) {
                    $('input[id="' + fin + '"]').trigger("click");
                }
            })
        })
    })
    $(document).on('click', '#save_validate', function () {
        let callApi5 = callapi2.call(this, 'save_validate');
        callApi5.done(function (data) {
            let a = $(this).closest('tr');
            resultados5 = JSON.parse(data);
            a.removeClass('alert alert-danger').removeClass('alert alert-success');
            if (resultados5 != true) {
                a.addClass('alert alert-danger');
                return;
            }
            a.addClass('alert alert-success');
            let callapi6 = callapi2.call(this, 'search');
            callapi6.done(function (data) {
                resultados8 = JSON.parse(data);
                let filas;
                $.each((resultados8.datos), function (key, i) {
                    filas = getRow(i);
                });
                let callapi8 = callapi2('search');
                callapi8.done(function (data) {
                    resultados10 = JSON.parse(data);
                    // console.log(resultados10.contador);
                    let paginas = Math.ceil(resultados10.contador / 5);
                    let botones = " ";
                    for (i = 0; i < paginas; i++) {
                        botones +=
                            '<li class="page-item"><input type="button" class="page-link" id=' +
                            i +
                            ' value=' + (parseInt(i) + parseInt(1)) + '></li>';
                    }
                    let fin = parseInt(i) - parseInt(1);
                    if ((((resultados10.contador) % 5) - 1) != 0) {
                        $('input[id="' + fin + '"]').trigger("click");
                        $('#result').before(filas);
                    } else {
                        $('#botones').empty().append(botones);
                        $('input[id="' + fin + '"]').trigger("click");
                    }
                    // a.removeClass('bg-danger');
                    a.removeClass('alert alert-success');
                    $('input').removeClass('alert alert-danger').removeClass(
                        'alert alert-success');
                })
            })
        })
    })
    $(document).on('click', '.page-link', function () {
        let callApi6 = callapi.call(this, 'search');
        callApi6.done(function (data) {
            resultados6 = JSON.parse(data);
            showTable(resultados6.datos);
            if ($('#boton').is(':checked')) {
                $('svg[class="icon icon-tabler icon-tabler-trash"]').hide();
            }
        })
    })
</script>

</html>